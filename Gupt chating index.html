<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tingling</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ---------------------------------- */
        /* --- 1. GLOBAL & THEME STYLES --- */
        /* ---------------------------------- */
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --accent-color: #0f3460;
            --text-color: #e94560;
            --text-light: #f0f0f0;
            --glow-color: rgba(233, 69, 96, 0.7);
            --glass-bg: rgba(22, 33, 62, 0.6);
            --red-badge: #e94560;
        }

        body.light-mode {
            --primary-bg: #f0f8ff;
            --secondary-bg: #ffffff;
            --accent-color: #87ceeb;
            --text-color: #4682b4;
            --text-light: #333;
            --glow-color: rgba(70, 130, 180, 0.7);
            --glass-bg: rgba(255, 255, 255, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            color: var(--text-light);
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #16213e, #0f3460, #e94560);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
        }

        body.light-mode {
            background: linear-gradient(135deg, #87ceeb, #add8e6, #4682b4);
            background-size: 400% 400%;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        button {
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .hidden { display: none !important; }

        /* --------------------------- */
        /* --- 2. APP CONTAINER --- */
        /* --------------------------- */
        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            max-height: 900px;
            background: var(--primary-bg);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Glassmorphism Style */
        .glass-ui {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* --------------------------- */
        /* --- 3. AUTH VIEW --- */
        /* --------------------------- */
        #auth-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            height: 100%;
        }

        #auth-view h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 0 0 10px var(--glow-color);
            margin-bottom: 40px;
        }

        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-field {
            width: 100%;
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid var(--accent-color);
            background: transparent;
            color: var(--text-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-field::placeholder { color: rgba(255, 255, 255, 0.5); }
        body.light-mode .input-field::placeholder { color: rgba(51, 51, 51, 0.5); }

        .input-field:focus {
            outline: none;
            border-color: var(--text-color);
            box-shadow: 0 0 15px var(--glow-color);
        }

        .auth-button {
            padding: 15px;
            border-radius: 50px;
            background: var(--text-color);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .auth-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--glow-color);
        }

        .form-switch-link {
            color: var(--text-light);
            text-decoration: underline;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
        }

        /* --------------------------- */
        /* --- 4. MAIN APP UI --- */
        /* --------------------------- */
        #main-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .top-bar, .bottom-nav {
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 10;
        }

        .top-bar {
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .top-bar h2 {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .nav-btn {
            background: none;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            position: relative;
        }
        .nav-btn.active { color: var(--text-color); }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: var(--red-badge);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        /* Hide scrollbar */
        .content-area::-webkit-scrollbar { display: none; }
        .content-area { -ms-overflow-style: none; scrollbar-width: none; }

        .list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--secondary-bg);
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
        }
        .list-item:hover { background: var(--accent-color); }
        
        .list-item-avatar {
            font-size: 2rem;
            margin-right: 15px;
            line-height: 1;
        }
        .list-item-content { flex-grow: 1; }
        .list-item-title { font-weight: 500; color: var(--text-light); }
        .list-item-subtitle { font-size: 0.8rem; color: #a0a0a0; }
        body.light-mode .list-item-subtitle { color: #888; }

        .unread-badge {
            background: var(--text-color);
            color: white;
            border-radius: 50%;
            min-width: 22px;
            height: 22px;
            font-size: 0.8rem;
            padding: 0 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .bottom-nav {
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        /* --------------------------- */
        /* --- 5. CHAT VIEW --- */
        /* --------------------------- */
        #chat-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-bg);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        #chat-view.active { transform: translateX(0); }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            height: 60px;
            background: var(--secondary-bg);
            flex-shrink: 0;
        }
        .chat-header-title { flex-grow: 1; text-align: center; font-size: 1.2rem; }
        .chat-header button { background: none; color: var(--text-light); font-size: 1rem; }
        .chat-header .call-buttons { margin-left: auto; }

        #messages-container {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Newest messages at bottom */
        }
        /* For container with flex-direction: column-reverse */
        .messages-list { display: flex; flex-direction: column; }

        .message-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .message-bubble.sent {
            background: var(--text-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.received {
            background: var(--secondary-bg);
            color: var(--text-light);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            background: var(--secondary-bg);
            flex-shrink: 0;
        }
        #message-input {
            flex-grow: 1;
            border: none;
            background: var(--primary-bg);
            border-radius: 50px;
            padding: 10px 20px;
            color: var(--text-light);
            font-size: 1rem;
            outline: none;
        }
        #send-button {
            margin-left: 10px;
            padding: 0 25px;
            border-radius: 50px;
            background: var(--text-color);
            color: white;
            font-weight: 500;
        }

        /* --------------------------- */
        /* --- 6. CALLING UI --- */
        /* --------------------------- */
        #call-view, #audio-call-view {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        /* Video Call */
        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 150px;
            border: 3px solid var(--text-color);
            border-radius: 10px;
            object-fit: cover;
            cursor: move;
        }
        #call-view .call-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
        }
        .end-call-btn {
            background: #e74c3c;
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1rem;
        }

        /* Audio Call */
        #audio-call-view {
            flex-direction: column;
            background: linear-gradient(135deg, #16213e, #0f3460, #e94560);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
        }
        body.light-mode #audio-call-view {
            background: linear-gradient(135deg, #87ceeb, #add8e6, #4682b4);
            background-size: 400% 400%;
        }

        #audio-callee-avatar { font-size: 6rem; }
        #audio-callee-name { font-size: 2rem; margin-top: 20px; }
        #audio-call-status { font-size: 1rem; color: #ccc; margin-top: 10px; }
        
        #audio-call-view .call-controls {
            position: absolute;
            bottom: 40px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        #audio-call-view .call-control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #audio-call-view .call-control-btn.active {
            background: var(--text-color);
        }

        /* --------------------------- */
        /* --- 7. MODALS --- */
        /* --------------------------- */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 300;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            width: 100%;
            max-width: 350px;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text-light);
        }
        .modal-text {
            color: var(--text-light);
            margin-bottom: 20px;
        }
        .modal-input {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 50px;
            border: 2px solid var(--accent-color);
            background: var(--primary-bg);
            color: var(--text-light);
            font-size: 1rem;
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--text-color);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-button {
            flex-grow: 1;
            padding: 12px;
            border-radius: 50px;
            background: var(--accent-color);
            color: white;
            font-weight: 500;
            transition: background 0.2s;
        }
        .modal-button.primary { background: var(--text-color); }
        .modal-button.secondary { background: #555; }
        
        #incoming-call-modal .modal-title {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

    <!-- App Container -->
    <div class="app-container">

        <!-- Authentication View -->
        <div id="auth-view">
            <h1>Tingling</h1>
            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <input type="email" id="login-email" class="input-field" placeholder="Email" required>
                <input type="password" id="login-password" class="input-field" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
                <p class="form-switch-link" id="show-signup">Don't have an account? Sign Up</p>
            </form>
            <!-- Signup Form -->
            <form id="signup-form" class="auth-form hidden">
                <input type="email" id="signup-email" class="input-field" placeholder="Email" required>
                <input type="password" id="signup-password" class="input-field" placeholder="Password" required>
                <button type="submit" class="auth-button">Sign Up</button>
                <p class="form-switch-link" id="show-login">Already have an account? Login</p>
            </form>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="hidden">
            <header class="top-bar glass-ui">
                <button class="nav-btn" id="menu-btn">Menu</button>
                <h2>Tingling</h2>
                <button class="nav-btn" id="add-friend-btn">Add Friend</button>
            </header>
            <main class="content-area" id="content-area"></main>
            <nav class="bottom-nav glass-ui">
                <button class="nav-btn active" data-view="home">Home</button>
                <button class="nav-btn" data-view="notifications">Notifications<span id="notification-badge" class="notification-badge hidden"></span></button>
                <button class="nav-btn" data-view="calls">Calls</button>
            </nav>
        </div>

        <!-- Chat View -->
        <div id="chat-view">
            <header class="chat-header">
                <button id="chat-back-btn">Back</button>
                <h3 id="chat-header-title" class="chat-header-title">Contact Name</h3>
                <div class="call-buttons">
                    <button id="voice-call-btn">Voice</button>
                    <button id="video-call-btn">Video</button>
                </div>
            </header>
            <div id="messages-container">
                <div class="messages-list" id="messages-list">
                    <!-- Message bubbles will be appended here -->
                </div>
            </div>
            <footer class="chat-input-area">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-button">Send</button>
            </footer>
        </div>

        <!-- Video Call View -->
        <div id="call-view" class="hidden">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-controls">
                <button id="end-video-call-btn" class="end-call-btn">End</button>
            </div>
        </div>

        <!-- Audio Call View -->
        <div id="audio-call-view" class="hidden">
            <div id="audio-callee-avatar"></div>
            <h2 id="audio-callee-name"></h2>
            <p id="audio-call-status">Calling...</p>
            <div class="call-controls">
                <button id="speaker-toggle-btn" class="call-control-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>
                <button id="end-audio-call-btn" class="end-call-btn">End</button>
            </div>
        </div>
        
    </div>

    <!-- Modals -->
    <div id="user-details-modal" class="modal-overlay hidden">
        <div class="modal-content glass-ui">
            <h3 class="modal-title">Welcome to Tingling!</h3>
            <p class="modal-text">Let's set up your profile.</p>
            <input type="text" id="user-name-input" class="modal-input" placeholder="Your Name"required>
            <input type="text" id="user-emoji-input" class="modal-input" placeholder="Your Emoji (e.g., ðŸ˜Š)" maxlength="2" required>
            <div class="modal-buttons">
                <button id="save-user-details-btn" class="modal-button primary">Save Profile</button>
            </div>
        </div>
    </div>
    
    <div id="add-friend-modal" class="modal-overlay hidden">
        <div class="modal-content glass-ui">
            <h3 class="modal-title">Add a Friend</h3>
            <input type="text" id="friend-id-input" class="modal-input" placeholder="Enter friend's Tingling ID (e.g., ting-xxxx)">
            <div class="modal-buttons">
                <button id="search-friend-btn" class="modal-button primary">Search</button>
                <button id="close-add-friend-modal-btn" class="modal-button secondary">Close</button>
            </div>
            <div id="friend-search-result" class="hidden" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    <div id="menu-modal" class="modal-overlay hidden">
        <div class="modal-content glass-ui">
            <h3 class="modal-title">Menu</h3>
            <div class="modal-buttons" style="flex-direction: column;">
                <button id="profile-btn" class="modal-button">Profile</button>
                <button id="blocked-users-btn" class="modal-button">Blocked Users</button>
                <button id="theme-toggle-btn" class="modal-button">Toggle Theme</button>
                <button id="logout-btn" class="modal-button primary">Logout</button>
                <button id="close-menu-modal-btn" class="modal-button secondary" style="margin-top: 20px;">Close</button>
            </div>
        </div>
    </div>

    <div id="user-profile-modal" class="modal-overlay hidden">
        <div class="modal-content glass-ui">
            <h3 class="modal-title">Your Profile</h3>
            <p class="modal-text" id="profile-user-id"></p>
            <input type="text" id="profile-name-input" class="modal-input" placeholder="Your Name">
            <input type="text" id="profile-emoji-input" class="modal-input" placeholder="Your Emoji (e.g., ðŸ˜Š)" maxlength="2">
            <div class="modal-buttons">
                 <button id="save-profile-btn" class="modal-button primary">Save</button>
                 <button id="close-profile-modal-btn" class="modal-button secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="contact-profile-modal" class="modal-overlay hidden">
        <div class="modal-content glass-ui">
            <h3 class="modal-title" id="contact-profile-name"></h3>
            <p class="modal-text" id="contact-profile-id"></p>
            <div class="modal-buttons" style="flex-direction: column;">
                <button id="block-user-btn" class="modal-button secondary">Block User</button>
                <button id="delete-chat-btn" class="modal-button" style="background: #e74c3c;">Delete Chat</button>
                <button id="close-contact-profile-btn" class="modal-button" style="margin-top:20px;">Close</button>
            </div>
        </div>
    </div>

    <div id="blocked-users-modal" class="modal-overlay hidden">
        <div class="modal-content glass-ui" style="max-height: 80vh; display: flex; flex-direction: column;">
            <h3 class="modal-title">Blocked Users</h3>
            <div id="blocked-users-list" style="flex-grow: 1; overflow-y: auto; text-align: left; width: 100%;">
                <!-- Blocked users will be listed here -->
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button id="close-blocked-users-modal-btn" class="modal-button secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="incoming-call-modal" class="modal-overlay hidden">
        <div class="modal-content glass-ui">
            <h3 class="modal-title" id="incoming-call-title">Incoming Call...</h3>
            <p id="incoming-call-from" class="modal-text"></p>
            <div class="modal-buttons">
                <button id="accept-call-btn" class="modal-button" style="background: #2ecc71;">Accept</button>
                <button id="reject-call-btn" class="modal-button" style="background: #e74c3c;">Reject</button>
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="ringtone" src="data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAAD/////////////////" loop></audio>
    <audio id="message-tone" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU="></audio>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
    (function() {
        // --- 1. FIREBASE CONFIGURATION ---
        // IMPORTANT: Fill in your Firebase project configuration below
        const firebaseConfig = {
Â Â apiKey: "AIzaSyAR4Gdeg7xMOnr71rMZL9CWhuQv49Lguk0",
Â Â authDomain: "my-first-app-52ed7.firebaseapp.com",
Â Â databaseURL: "https://my-first-app-52ed7-default-rtdb.firebaseio.com",
Â Â projectId: "my-first-app-52ed7",
Â Â storageBucket: "my-first-app-52ed7.firebasestorage.app",
Â Â messagingSenderId: "920217717092",
Â Â appId: "1:920217717092:web:d1a92e1c969f492e749271"
};

        // --- 2. INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- 3. GLOBAL STATE & DOM ELEMENTS ---
        let currentUser = null;
        let currentChat = { id: null, friendId: null, friendName: null, friendEmoji: null };
        let currentView = 'home';
        let listeners = {}; // To store active Firebase listeners

        // Call state
        let peerConnection;
        let localStream;
        let remoteStream;
        let currentCall = { id: null, type: null, isCaller: false, peerId: null };
        let isSpeakerOn = false;

        const dom = {
            appContainer: document.querySelector('.app-container'),
            // Views
            authView: document.getElementById('auth-view'),
            mainView: document.getElementById('main-view'),
            chatView: document.getElementById('chat-view'),
            callView: document.getElementById('call-view'),
            audioCallView: document.getElementById('audio-call-view'),
            // Auth Forms
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            showSignupLink: document.getElementById('show-signup'),
            showLoginLink: document.getElementById('show-login'),
            // Main UI
            contentArea: document.getElementById('content-area'),
            bottomNav: document.querySelector('.bottom-nav'),
            menuBtn: document.getElementById('menu-btn'),
            addFriendBtn: document.getElementById('add-friend-btn'),
            notificationBadge: document.getElementById('notification-badge'),
            // Chat UI
            chatHeaderTitle: document.getElementById('chat-header-title'),
            chatBackBtn: document.getElementById('chat-back-btn'),
            messagesContainer: document.getElementById('messages-container'),
            messagesList: document.getElementById('messages-list'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            voiceCallBtn: document.getElementById('voice-call-btn'),
            videoCallBtn: document.getElementById('video-call-btn'),
            // Call UIs
            localVideo: document.getElementById('local-video'),
            remoteVideo: document.getElementById('remote-video'),
            endVideoCallBtn: document.getElementById('end-video-call-btn'),
            audioCalleeAvatar: document.getElementById('audio-callee-avatar'),
            audioCalleeName: document.getElementById('audio-callee-name'),
            audioCallStatus: document.getElementById('audio-call-status'),
            speakerToggleBtn: document.getElementById('speaker-toggle-btn'),
            endAudioCallBtn: document.getElementById('end-audio-call-btn'),
            // Modals
            userDetailsModal: document.getElementById('user-details-modal'),
            saveUserDetailsBtn: document.getElementById('save-user-details-btn'),
            userNameInput: document.getElementById('user-name-input'),
            userEmojiInput: document.getElementById('user-emoji-input'),

            addFriendModal: document.getElementById('add-friend-modal'),
            friendIdInput: document.getElementById('friend-id-input'),
            searchFriendBtn: document.getElementById('search-friend-btn'),
            friendSearchResult: document.getElementById('friend-search-result'),
            closeAddFriendModalBtn: document.getElementById('close-add-friend-modal-btn'),

            menuModal: document.getElementById('menu-modal'),
            profileBtn: document.getElementById('profile-btn'),
            blockedUsersBtn: document.getElementById('blocked-users-btn'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            closeMenuModalBtn: document.getElementById('close-menu-modal-btn'),
            
            userProfileModal: document.getElementById('user-profile-modal'),
            profileUserId: document.getElementById('profile-user-id'),
            profileNameInput: document.getElementById('profile-name-input'),
            profileEmojiInput: document.getElementById('profile-emoji-input'),
            saveProfileBtn: document.getElementById('save-profile-btn'),
            closeProfileModalBtn: document.getElementById('close-profile-modal-btn'),
            
            contactProfileModal: document.getElementById('contact-profile-modal'),
            contactProfileName: document.getElementById('contact-profile-name'),
            contactProfileId: document.getElementById('contact-profile-id'),
            blockUserBtn: document.getElementById('block-user-btn'),
            deleteChatBtn: document.getElementById('delete-chat-btn'),
            closeContactProfileBtn: document.getElementById('close-contact-profile-btn'),
            
            blockedUsersModal: document.getElementById('blocked-users-modal'),
            blockedUsersList: document.getElementById('blocked-users-list'),
            closeBlockedUsersModalBtn: document.getElementById('close-blocked-users-modal-btn'),

            incomingCallModal: document.getElementById('incoming-call-modal'),
            incomingCallTitle: document.getElementById('incoming-call-title'),
            incomingCallFrom: document.getElementById('incoming-call-from'),
            acceptCallBtn: document.getElementById('accept-call-btn'),
            rejectCallBtn: document.getElementById('reject-call-btn'),
            // Audio
            ringtone: document.getElementById('ringtone'),
            messageTone: document.getElementById('message-tone'),
        };

        const RTCPeerConnectionConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // --- 4. AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                db.ref(`users/${user.uid}`).once('value', snapshot => {
                    if (snapshot.exists()) {
                        currentUser = { uid: user.uid, email: user.email, ...snapshot.val() };
                        initializeAppForUser();
                    } else {
                        // New user, needs to set up profile
                        showModal(dom.userDetailsModal);
                        dom.authView.classList.add('hidden');
                    }
                });
            } else {
                currentUser = null;
                cleanupApp();
                dom.authView.classList.remove('hidden');
                dom.mainView.classList.add('hidden');
            }
        });

        function handleLogin(e) {
            e.preventDefault();
            const email = dom.loginForm['login-email'].value;
            const password = dom.loginForm['login-password'].value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => alert(`Login Error: ${err.message}`));
        }

        function handleSignup(e) {
            e.preventDefault();
            const email = dom.signupForm['signup-email'].value;
            const password = dom.signupForm['signup-password'].value;
            auth.createUserWithEmailAndPassword(email, password)
                .catch(err => alert(`Signup Error: ${err.message}`));
        }

        function handleSaveUserDetails() {
            const name = dom.userNameInput.value.trim();
            const emoji = dom.userEmojiInput.value.trim();
            if (!name || !emoji) {
                alert('Please enter your name and an emoji.');
                return;
            }

            const user = auth.currentUser;
            if (user) {
                const userId = `ting-${Math.random().toString(36).substr(2, 4)}`;
                const userProfile = {
                    name,
                    emoji,
                    email: user.email,
                    userId,
                    callStatus: 'available'
                };
                db.ref(`users/${user.uid}`).set(userProfile).then(() => {
                    currentUser = { uid: user.uid, ...userProfile };
                    hideModal(dom.userDetailsModal);
                    initializeAppForUser();
                }).catch(err => alert(`Profile Error: ${err.message}`));
            }
        }

        function handleLogout() {
            if(currentUser) {
                db.ref(`users/${currentUser.uid}/callStatus`).set(null);
            }
            auth.signOut();
        }

        // --- 5. APP INITIALIZATION & CLEANUP ---
        function initializeAppForUser() {
            dom.authView.classList.add('hidden');
            dom.mainView.classList.remove('hidden');
            
            // Set presence
            const userStatusRef = db.ref(`/users/${currentUser.uid}/callStatus`);
            userStatusRef.onDisconnect().set('offline').then(() => {
                userStatusRef.set('available');
            });
            
            // Attach all necessary listeners
            attachListeners();
            
            // Initial view
            switchView('home');
        }

        function cleanupApp() {
            // Detach all Firebase listeners
            Object.values(listeners).forEach(l => l.ref.off(l.event, l.callback));
            listeners = {};
            // Hide all views and modals
            [dom.mainView, dom.chatView, dom.callView, dom.audioCallView].forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden'));
        }

        function attachListeners() {
            // Listen for notifications
            const notifRef = db.ref(`notifications/${currentUser.uid}`);
            const notifCallback = snapshot => updateNotifications();
            notifRef.on('value', notifCallback);
            listeners.notifications = { ref: notifRef, event: 'value', callback: notifCallback };

            // Listen for contacts
            const contactsRef = db.ref(`contacts/${currentUser.uid}`);
            const contactsCallback = snapshot => {
                if(currentView === 'home') renderHomeView();
            };
            contactsRef.on('value', contactsCallback);
            listeners.contacts = { ref: contactsRef, event: 'value', callback: contactsCallback };

            // Listen for incoming calls
            const callsRef = db.ref('calls').orderByChild('receiverId').equalTo(currentUser.uid);
            const callsCallback = snapshot => {
                snapshot.forEach(childSnapshot => {
                    const call = childSnapshot.val();
                    if (call && call.status === 'ringing') {
                        handleIncomingCall(childSnapshot.key, call);
                    }
                });
            };
            callsRef.on('child_added', callsCallback);
            listeners.calls = { ref: callsRef, event: 'child_added', callback: callsCallback };
        }

        // --- 6. UI MANAGEMENT ---
        function showModal(modal) { modal.classList.remove('hidden'); }
        function hideModal(modal) { modal.classList.add('hidden'); }

        function switchView(view) {
            currentView = view;
            dom.contentArea.innerHTML = '';
            document.querySelectorAll('.bottom-nav .nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            switch (view) {
                case 'home':
                    renderHomeView();
                    break;
                case 'notifications':
                    renderNotificationsView();
                    break;
                case 'calls':
                    renderCallsView();
                    break;
            }
        }
        
        function updateNotifications() {
             const notifRef = db.ref(`notifications/${currentUser.uid}`);
             notifRef.once('value', snapshot => {
                let unreadCount = 0;
                snapshot.forEach(child => {
                    if(!child.val().read) unreadCount++;
                });
                if (unreadCount > 0) {
                    dom.notificationBadge.textContent = unreadCount;
                    dom.notificationBadge.classList.remove('hidden');
                } else {
                    dom.notificationBadge.classList.add('hidden');
                }
                if (currentView === 'notifications') {
                    renderNotificationsView();
                }
             });
        }
        
        function createListItem(options) {
            const item = document.createElement('div');
            item.className = 'list-item';
            if (options.onClick) item.onclick = options.onClick;
            if (options.onContext) { // For long press/right click
                item.oncontextmenu = (e) => {
                    e.preventDefault();
                    options.onContext();
                };
            }

            let avatar = `<div class="list-item-avatar">${options.avatar || 'â€¢'}</div>`;
            
            let content = `<div class="list-item-content">
                <div class="list-item-title">${options.title}</div>
                <div class="list-item-subtitle">${options.subtitle || ''}</div>
            </div>`;
            
            let badge = '';
            if (options.badgeCount > 0) {
                badge = `<div class="unread-badge">${options.badgeCount}</div>`;
            }

            item.innerHTML = avatar + content + badge;
            return item;
        }

        // --- 7. VIEW RENDERERS ---
        async function renderHomeView() {
            dom.contentArea.innerHTML = '<h3>Contacts</h3>';
            const contactsSnapshot = await db.ref(`contacts/${currentUser.uid}`).once('value');
            if (!contactsSnapshot.exists()) {
                dom.contentArea.innerHTML += '<p style="text-align:center; margin-top: 20px;">Add friends to start chatting!</p>';
                return;
            }

            const unreadCountsSnapshot = await db.ref(`unreadCounts/${currentUser.uid}`).once('value');
            const unreadCounts = unreadCountsSnapshot.val() || {};

            for (const friendUid of Object.keys(contactsSnapshot.val())) {
                const userSnapshot = await db.ref(`users/${friendUid}`).once('value');
                if (userSnapshot.exists()) {
                    const friend = userSnapshot.val();
                    const chatId = getChatId(currentUser.uid, friendUid);
                    
                    const item = createListItem({
                        avatar: friend.emoji,
                        title: friend.name,
                        subtitle: `ID: ${friend.userId}`,
                        badgeCount: unreadCounts[chatId] || 0,
                        onClick: () => openChat(friendUid, friend.name, friend.emoji),
                        onContext: () => openContactProfile(friendUid, friend.name, friend.userId)
                    });
                    dom.contentArea.appendChild(item);
                }
            }
        }
        
        async function renderNotificationsView() {
            dom.contentArea.innerHTML = '<h3>Notifications</h3>';
            const notifRef = db.ref(`notifications/${currentUser.uid}`);
            const snapshot = await notifRef.once('value');
            if (!snapshot.exists()) {
                dom.contentArea.innerHTML += '<p style="text-align:center; margin-top: 20px;">No new notifications.</p>';
                return;
            }
            
            snapshot.forEach(child => {
                const notif = child.val();
                const notifId = child.key;
                let item;
                if(notif.type === 'friend_request') {
                    item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="list-item-avatar">${notif.emoji}</div>
                        <div class="list-item-content">
                            <div class="list-item-title">${notif.name} sent you a friend request.</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="modal-button primary" style="padding: 5px 10px;" data-from="${notif.from}" data-notif-id="${notifId}">Accept</button>
                            <button class="modal-button secondary" style="padding: 5px 10px;" data-from="${notif.from}" data-notif-id="${notifId}">Decline</button>
                        </div>
                    `;
                    item.querySelector('.primary').onclick = (e) => acceptFriendRequest(e.target.dataset.from, e.target.dataset.notifId);
                    item.querySelector('.secondary').onclick = (e) => declineFriendRequest(e.target.dataset.from, e.target.dataset.notifId);
                }
                if (item) dom.contentArea.appendChild(item);
            });
            notifRef.update({ read: true });
        }
        
        async function renderCallsView() {
            dom.contentArea.innerHTML = '<h3>Call History</h3>';
            const snapshot = await db.ref(`callHistory/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).once('value');
            if (!snapshot.exists()) {
                dom.contentArea.innerHTML += '<p style="text-align:center; margin-top: 20px;">No calls yet.</p>';
                return;
            }

            let callsHtml = [];
            snapshot.forEach(child => {
                const log = child.val();
                const directionIcon = log.direction === 'outgoing' ? 'â†—' : 'â†™';
                const callIcon = log.callType === 'video' ? 'ðŸ“¹' : 'ðŸ“ž';
                const date = new Date(log.timestamp).toLocaleString();
                callsHtml.unshift(createListItem({
                    avatar: callIcon,
                    title: `${directionIcon} ${log.peerName}`,
                    subtitle: `${log.status} - ${date}`
                }));
            });
            callsHtml.forEach(item => dom.contentArea.appendChild(item));
        }

        // --- 8. FRIEND SYSTEM ---
        function handleAddFriend() {
            dom.friendIdInput.value = '';
            dom.friendSearchResult.classList.add('hidden');
            dom.friendSearchResult.innerHTML = '';
            showModal(dom.addFriendModal);
        }
        
        function handleSearchFriend() {
            const friendId = dom.friendIdInput.value.trim();
            if(!friendId) return;

            db.ref('users').orderByChild('userId').equalTo(friendId).once('value', snapshot => {
                dom.friendSearchResult.classList.remove('hidden');
                if (snapshot.exists()) {
                    const [uid, userData] = Object.entries(snapshot.val())[0];
                    if (uid === currentUser.uid) {
                        dom.friendSearchResult.innerHTML = '<p>You cannot add yourself.</p>';
                        return;
                    }
                    dom.friendSearchResult.innerHTML = `
                        <p>${userData.emoji} ${userData.name}</p>
                        <button id="send-request-btn" class="modal-button primary" style="margin-top:10px;">Send Request</button>
                    `;
                    document.getElementById('send-request-btn').onclick = () => sendFriendRequest(uid, userData);
                } else {
                    dom.friendSearchResult.innerHTML = '<p>User not found.</p>';
                }
            });
        }
        
        function sendFriendRequest(targetUid, targetData) {
            const request = {
                from: currentUser.uid,
                name: currentUser.name,
                emoji: currentUser.emoji,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            const notification = {
                type: 'friend_request',
                from: currentUser.uid,
                name: currentUser.name,
                emoji: currentUser.emoji,
                read: false
            };
            db.ref(`requests/${targetUid}/${currentUser.uid}`).set(request);
            db.ref(`notifications/${targetUid}`).push(notification);
            alert('Friend request sent!');
            hideModal(dom.addFriendModal);
        }

        function acceptFriendRequest(requesterUid, notifId) {
            db.ref(`contacts/${currentUser.uid}/${requesterUid}`).set(true);
            db.ref(`contacts/${requesterUid}/${currentUser.uid}`).set(true);
            db.ref(`requests/${currentUser.uid}/${requesterUid}`).remove();
            db.ref(`notifications/${currentUser.uid}/${notifId}`).remove();
        }
        
        function declineFriendRequest(requesterUid, notifId) {
            db.ref(`requests/${currentUser.uid}/${requesterUid}`).remove();
            db.ref(`notifications/${currentUser.uid}/${notifId}`).remove();
        }
        
        function openContactProfile(friendUid, friendName, friendUserId) {
            dom.contactProfileName.textContent = friendName;
            dom.contactProfileId.textContent = `ID: ${friendUserId}`;
            dom.blockUserBtn.onclick = () => {
                if(confirm(`Are you sure you want to block ${friendName}?`)) {
                    blockUser(friendUid);
                    hideModal(dom.contactProfileModal);
                }
            };
            dom.deleteChatBtn.onclick = () => {
                if(confirm(`Are you sure you want to delete your chat history with ${friendName}? This cannot be undone.`)) {
                    deleteChat(friendUid);
                    hideModal(dom.contactProfileModal);
                }
            };
            showModal(dom.contactProfileModal);
        }

        function blockUser(blockedUid) {
            db.ref(`blocked/${currentUser.uid}/${blockedUid}`).set(true);
            db.ref(`contacts/${currentUser.uid}/${blockedUid}`).remove();
            db.ref(`contacts/${blockedUid}/${currentUser.uid}`).remove();
            alert('User blocked.');
        }

        async function renderBlockedUsers() {
            showModal(dom.blockedUsersModal);
            dom.blockedUsersList.innerHTML = '';
            const snapshot = await db.ref(`blocked/${currentUser.uid}`).once('value');
            if (!snapshot.exists()) {
                dom.blockedUsersList.innerHTML = '<p>No blocked users.</p>';
                return;
            }
            for (const blockedUid of Object.keys(snapshot.val())) {
                const userSnap = await db.ref(`users/${blockedUid}`).once('value');
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="list-item-avatar">${userData.emoji}</div>
                        <div class="list-item-content">
                            <div class="list-item-title">${userData.name}</div>
                        </div>
                        <button class="modal-button" style="padding: 5px 10px;">Unblock</button>
                    `;
                    item.querySelector('button').onclick = () => unblockUser(blockedUid);
                    dom.blockedUsersList.appendChild(item);
                }
            }
        }
        
        function unblockUser(blockedUid) {
            db.ref(`blocked/${currentUser.uid}/${blockedUid}`).remove();
            renderBlockedUsers();
        }

        // --- 9. REAL-TIME MESSAGING ---
        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }
        
        function openChat(friendId, friendName, friendEmoji) {
            currentChat = { id: getChatId(currentUser.uid, friendId), friendId, friendName, friendEmoji };
            
            dom.chatHeaderTitle.textContent = friendName;
            dom.messagesList.innerHTML = '';
            dom.chatView.classList.add('active');
            
            // Clear unread count
            db.ref(`unreadCounts/${currentUser.uid}/${currentChat.id}`).remove();

            // Listen for new messages
            const messagesRef = db.ref(`messages/${currentChat.id}`).limitToLast(50);
            const messageCallback = snapshot => {
                const message = snapshot.val();
                renderMessage(message);
                if(document.visibilityState === 'visible' && dom.chatView.classList.contains('active')) {
                   dom.messageTone.play();
                }
            };
            messagesRef.on('child_added', messageCallback);
            listeners.messages = { ref: messagesRef, event: 'child_added', callback: messageCallback };
        }
        
        function closeChat() {
            if (listeners.messages) {
                listeners.messages.ref.off(listeners.messages.event, listeners.messages.callback);
                delete listeners.messages;
            }
            dom.chatView.classList.remove('active');
            currentChat = { id: null, friendId: null, friendName: null };
            renderHomeView(); // Refresh home view to show correct unread counts
        }

        function renderMessage(message) {
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.classList.add(message.senderId === currentUser.uid ? 'sent' : 'received');
            bubble.textContent = message.text;
            dom.messagesList.prepend(bubble);
        }

        function sendMessage() {
            const text = dom.messageInput.value.trim();
            if (text === '' || !currentChat.id) return;
            
            const message = {
                text,
                senderId: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            db.ref(`messages/${currentChat.id}`).push(message);
            
            // Increment unread count for friend
            const unreadRef = db.ref(`unreadCounts/${currentChat.friendId}/${currentChat.id}`);
            unreadRef.transaction(currentCount => (currentCount || 0) + 1);

            dom.messageInput.value = '';
            dom.messageInput.focus();
        }

        function deleteChat(friendUid) {
            const chatId = getChatId(currentUser.uid, friendUid);
            db.ref(`messages/${chatId}`).remove();
            db.ref(`unreadCounts/${currentUser.uid}/${chatId}`).remove();
            db.ref(`unreadCounts/${friendUid}/${chatId}`).remove();
            alert('Chat history deleted.');
        }

        // --- 10. WEBRTC CALLING ---
        async function initiateCall(friendId, isVideo) {
            try {
                // Check if friend is available
                const friendStatusSnap = await db.ref(`users/${friendId}/callStatus`).once('value');
                if (friendStatusSnap.val() !== 'available') {
                    alert('Your friend is currently busy or offline.');
                    return;
                }
                
                await db.ref(`users/${currentUser.uid}/callStatus`).set('busy');

                const callId = db.ref('calls').push().key;
                currentCall = { id: callId, type: isVideo ? 'video' : 'audio', isCaller: true, peerId: friendId };

                // Get media stream
                localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
                
                // Show call UI
                if(isVideo) {
                    showModal(dom.callView);
                    dom.localVideo.srcObject = localStream;
                } else {
                    const friendData = (await db.ref(`users/${friendId}`).once('value')).val();
                    dom.audioCalleeAvatar.textContent = friendData.emoji;
                    dom.audioCalleeName.textContent = friendData.name;
                    dom.audioCallStatus.textContent = 'Calling...';
                    showModal(dom.audioCallView);
                }

                // Create Peer Connection
                peerConnection = new RTCPeerConnection(RTCPeerConnectionConfig);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                setupPeerConnectionListeners();
                
                // Create Offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Create call in Firebase
                const callData = {
                    callerId: currentUser.uid,
                    receiverId: friendId,
                    offer,
                    status: 'ringing',
                    isVideo
                };
                await db.ref(`calls/${callId}`).set(callData);

                // Listen for answer and ICE candidates
                listenForCallUpdates(callId, friendId);

            } catch (error) {
                console.error("Error initiating call:", error);
                alert("Could not start call. Check camera/microphone permissions.");
                cleanupCall();
            }
        }

        function handleIncomingCall(callId, callData) {
            // Avoid handling own calls or calls while busy
            if (currentCall.id || currentUser.callStatus !== 'available') {
                db.ref(`calls/${callId}`).update({ status: 'rejected_busy' });
                return;
            }

            currentCall = { id: callId, type: callData.isVideo ? 'video' : 'audio', isCaller: false, peerId: callData.callerId };
            
            db.ref(`users/${callData.callerId}`).once('value', snapshot => {
                const callerData = snapshot.val();
                dom.incomingCallTitle.textContent = `Incoming ${currentCall.type} call`;
                dom.incomingCallFrom.textContent = `${callerData.emoji} ${callerData.name}`;
                showModal(dom.incomingCallModal);
                dom.ringtone.play();

                dom.acceptCallBtn.onclick = () => answerCall(callId, callData);
                dom.rejectCallBtn.onclick = () => rejectCall(callId);
            });
        }
        
        async function answerCall(callId, callData) {
            hideModal(dom.incomingCallModal);
            dom.ringtone.pause();
            
            try {
                await db.ref(`users/${currentUser.uid}/callStatus`).set('busy');
                
                localStream = await navigator.mediaDevices.getUserMedia({ video: callData.isVideo, audio: true });

                if (callData.isVideo) {
                    showModal(dom.callView);
                    dom.localVideo.srcObject = localStream;
                } else {
                    const callerData = (await db.ref(`users/${callData.callerId}`).once('value')).val();
                    dom.audioCalleeAvatar.textContent = callerData.emoji;
                    dom.audioCalleeName.textContent = callerData.name;
                    dom.audioCallStatus.textContent = 'Connecting...';
                    showModal(dom.audioCallView);
                }
                
                peerConnection = new RTCPeerConnection(RTCPeerConnectionConfig);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                setupPeerConnectionListeners();

                await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                await db.ref(`calls/${callId}`).update({ answer, status: 'answered' });
                
                listenForCallUpdates(callId, callData.callerId);

            } catch (error) {
                console.error("Error answering call:", error);
                alert("Could not answer call. Check permissions.");
                cleanupCall();
            }
        }

        function rejectCall(callId) {
            hideModal(dom.incomingCallModal);
            dom.ringtone.pause();
            db.ref(`calls/${callId}`).update({ status: 'rejected' });
            cleanupCall();
        }

        function endCall() {
            if (currentCall.id) {
                db.ref(`calls/${currentCall.id}`).update({ status: 'ended' });
            }
            cleanupCall();
        }
        
        function cleanupCall(callStatus = 'ended') {
            logCallHistory(callStatus);

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (listeners.callUpdates) {
                listeners.callUpdates.ref.off();
                delete listeners.callUpdates;
            }
            if(listeners.iceCandidates) {
                listeners.iceCandidates.ref.off();
                delete listeners.iceCandidates;
            }
            
            // Remove the call document after a short delay
            if (currentCall.id && currentCall.isCaller) {
                setTimeout(() => db.ref(`calls/${currentCall.id}`).remove(), 5000);
                setTimeout(() => db.ref(`iceCandidates/${currentCall.id}`).remove(), 5000);
            }
            
            db.ref(`users/${currentUser.uid}/callStatus`).set('available');

            hideModal(dom.callView);
            hideModal(dom.audioCallView);
            hideModal(dom.incomingCallModal);
            dom.ringtone.pause();
            dom.remoteVideo.srcObject = null;
            dom.localVideo.srcObject = null;

            currentCall = { id: null, type: null, isCaller: false, peerId: null };
        }

        function setupPeerConnectionListeners() {
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    db.ref(`iceCandidates/${currentCall.id}/${currentUser.uid}`).push(event.candidate.toJSON());
                }
            };
            
            peerConnection.ontrack = event => {
                remoteStream = event.streams[0];
                if (currentCall.type === 'video') {
                    dom.remoteVideo.srcObject = remoteStream;
                } else {
                    // For audio calls, we just need to know it's connected
                    dom.audioCallStatus.textContent = 'Connected';
                }
            };
        }

        function listenForCallUpdates(callId, peerId) {
            // Listen for answer/status changes
            const callRef = db.ref(`calls/${callId}`);
            const callCallback = async snapshot => {
                const callData = snapshot.val();
                if(!callData) { cleanupCall(); return; }

                if (callData.answer && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.answer));
                    if (currentCall.type === 'audio') dom.audioCallStatus.textContent = 'Connected';
                }
                if (callData.status === 'rejected' || callData.status === 'ended') {
                    cleanupCall(callData.status);
                }
            };
            callRef.on('value', callCallback);
            listeners.callUpdates = { ref: callRef, event: 'value', callback: callCallback };

            // Listen for ICE candidates from peer
            const iceRef = db.ref(`iceCandidates/${callId}/${peerId}`);
            const iceCallback = snapshot => {
                if (snapshot.exists()) {
                    peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val()));
                }
            };
            iceRef.on('child_added', iceCallback);
            listeners.iceCandidates = { ref: iceRef, event: 'child_added', callback: iceCallback };
        }
        
        async function logCallHistory(status) {
            if (!currentCall.id) return;
            
            const peerData = (await db.ref(`users/${currentCall.peerId}`).once('value')).val();
            const log = {
                callType: currentCall.type,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                direction: currentCall.isCaller ? 'outgoing' : 'incoming',
                peerId: currentCall.peerId,
                peerName: peerData.name,
                status,
            };

            // Log for current user
            db.ref(`callHistory/${currentUser.uid}`).push(log);
            // Log for peer
            const peerLog = { ...log, direction: currentCall.isCaller ? 'incoming' : 'outgoing' };
            db.ref(`callHistory/${currentCall.peerId}`).push(peerLog);
        }
        
        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            // This is a simplification. Real speakerphone control is complex.
            // For a web app, it generally routes audio to the default output.
            // This button serves as a UI indicator.
            dom.speakerToggleBtn.classList.toggle('active', isSpeakerOn);
        }

        // --- 11. MISC FEATURES (PROFILE, THEME, DRAGGING) ---
        function openProfileModal() {
            dom.profileUserId.textContent = `ID: ${currentUser.userId}`;
            dom.profileNameInput.value = currentUser.name;
            dom.profileEmojiInput.value = currentUser.emoji;
            showModal(dom.userProfileModal);
        }
        
        function saveProfile() {
            const newName = dom.profileNameInput.value.trim();
            const newEmoji = dom.profileEmojiInput.value.trim();
            if(!newName || !newEmoji) {
                alert('Name and emoji cannot be empty.');
                return;
            }
            db.ref(`users/${currentUser.uid}`).update({ name: newName, emoji: newEmoji }).then(() => {
                currentUser.name = newName;
                currentUser.emoji = newEmoji;
                alert('Profile updated!');
                hideModal(dom.userProfileModal);
                closeModal(dom.menuModal);
            });
        }
        
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }
        
        // Draggable local video
        let drag = { isDragging: false, currentX: 0, currentY: 0, initialX: 0, initialY: 0 };
        dom.localVideo.addEventListener('mousedown', e => {
            drag.isDragging = true;
            drag.initialX = e.clientX - drag.currentX;
            drag.initialY = e.clientY - drag.currentY;
            e.preventDefault();
        });
        document.addEventListener('mousemove', e => {
            if (drag.isDragging) {
                drag.currentX = e.clientX - drag.initialX;
                drag.currentY = e.clientY - drag.initialY;
                dom.localVideo.style.transform = `translate3d(${drag.currentX}px, ${drag.currentY}px, 0)`;
            }
        });
        document.addEventListener('mouseup', () => {
            drag.isDragging = false;
        });


        // --- 12. EVENT LISTENERS ---
        // Auth
        dom.loginForm.addEventListener('submit', handleLogin);
        dom.signupForm.addEventListener('submit', handleSignup);
        dom.showSignupLink.addEventListener('click', () => {
            dom.loginForm.classList.add('hidden');
            dom.signupForm.classList.remove('hidden');
        });
        dom.showLoginLink.addEventListener('click', () => {
            dom.signupForm.classList.add('hidden');
            dom.loginForm.classList.remove('hidden');
        });
        dom.saveUserDetailsBtn.addEventListener('click', handleSaveUserDetails);
        dom.logoutBtn.addEventListener('click', handleLogout);

        // Navigation
        dom.bottomNav.addEventListener('click', e => {
            if (e.target.matches('.nav-btn')) {
                switchView(e.target.dataset.view);
            }
        });
        
        // Modals & Menu
        dom.menuBtn.addEventListener('click', () => showModal(dom.menuModal));
        dom.closeMenuModalBtn.addEventListener('click', () => hideModal(dom.menuModal));
        dom.addFriendBtn.addEventListener('click', handleAddFriend);
        dom.searchFriendBtn.addEventListener('click', handleSearchFriend);
        dom.closeAddFriendModalBtn.addEventListener('click', () => hideModal(dom.addFriendModal));
        dom.profileBtn.addEventListener('click', () => { hideModal(dom.menuModal); openProfileModal(); });
        dom.saveProfileBtn.addEventListener('click', saveProfile);
        dom.closeProfileModalBtn.addEventListener('click', () => hideModal(dom.userProfileModal));
        dom.closeContactProfileBtn.addEventListener('click', () => hideModal(dom.contactProfileModal));
        dom.blockedUsersBtn.addEventListener('click', () => { hideModal(dom.menuModal); renderBlockedUsers(); });
        dom.closeBlockedUsersModalBtn.addEventListener('click', () => hideModal(dom.blockedUsersModal));
        dom.themeToggleBtn.addEventListener('click', toggleTheme);

        // Chat
        dom.chatBackBtn.addEventListener('click', closeChat);
        dom.sendButton.addEventListener('click', sendMessage);
        dom.messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Calling
        dom.voiceCallBtn.addEventListener('click', () => initiateCall(currentChat.friendId, false));
        dom.videoCallBtn.addEventListener('click', () => initiateCall(currentChat.friendId, true));
        dom.endVideoCallBtn.addEventListener('click', endCall);
        dom.endAudioCallBtn.addEventListener('click', endCall);
        dom.speakerToggleBtn.addEventListener('click', toggleSpeaker);

    })();
    </script>
</body>
</html>
